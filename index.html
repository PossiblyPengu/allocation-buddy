
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Allocation Buddy - Compact Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { 
      /* Pink-centered accent palette (soft but vivid) */
      --pink-1:#ec4899;  /* pink 500 */
      --pink-2:#f43f5e;  /* rose 500 */
      --pink-light:#fdf2f8; /* pink 50 */
      /* Neutrals */
      --ink-1:#1f2937; --ink-2:#0b1220; --light:#ffffff; --muted:#f3f4f6; 
      /* Semantic accents (kept; manual/auto remain green/yellow elsewhere) */
      --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
      --gradient-primary:linear-gradient(135deg, var(--pink-1) 0%, var(--pink-2) 100%);
      --gradient-dark:linear-gradient(135deg, var(--ink-1) 0%, var(--ink-2) 100%);
      --gradient-success:linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      --gradient-warning:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-danger:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background-color:#2f343e;
      background-image:
        radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        radial-gradient(rgba(0,0,0,0.12) 1px, transparent 1px),
        linear-gradient(180deg, #2b3039 0%, #1f232b 100%);
      background-size:24px 24px, 24px 24px, auto;
      background-position:0 0, 12px 12px, 0 0;
      min-height:100vh;padding:15px;color:#111;}
    .container{max-width:min(1600px,96vw);margin:0 auto;background:var(--light);border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;}
    .header{background:var(--gradient-dark);color:var(--light);padding:25px 40px;text-align:center;position:relative;overflow:hidden;isolation:isolate;}
    .header-art{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;display:block;filter:saturate(1.35) contrast(1.1) brightness(1.05)}
    .header h1,.header p{position:relative;z-index:1}
    .header h1{font-size:clamp(1.4rem,1.2vw+1rem,2.2rem);margin-bottom:8px;font-weight:300;}
    .help-button{position:absolute;top:20px;left:20px;z-index:10;padding:8px 12px;font-size:12px;line-height:1;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:6px;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:6px;}
    .help-button:hover{background:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.5);}
    /* Keep inner button text, but let wrapper handle clicks/size */
    .help-button button{background:transparent;border:none;color:inherit;font:inherit;padding:0;margin:0;pointer-events:none}
    .dark-mode-toggle{position:absolute;top:20px;right:20px;display:flex;align-items:center;gap:12px;color:#fff;font-size:14px;font-weight:500;z-index:10;}
    .toggle-switch{width:50px;height:24px;background:rgba(255,255,255,.2);border-radius:12px;position:relative;cursor:pointer;transition:all .3s ease;border:2px solid rgba(255,255,255,.3);}
    .toggle-switch:hover{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.5);}
    .toggle-switch::after{content:"";position:absolute;width:18px;height:18px;background:#fff;border-radius:50%;top:1px;left:1px;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.2);}
    .toggle-switch.active{background:var(--pink-1);border-color:var(--pink-1);}
    .toggle-switch.active::after{transform:translateX(26px);}
    .toggle-icon{font-size:16px;transition:all .3s ease;}
    .dashboard{padding:clamp(16px,1.8vw,28px);display:grid;grid-template-columns:clamp(260px,24vw,420px) 1fr;gap:clamp(14px,1.4vw,28px);align-items:stretch;}    
    .sidebar,.main-area{display:flex;flex-direction:column;gap:20px;}
    /* Make the Store Management card fill the column height */
    .sidebar .card{flex:0 0 auto;display:flex;flex-direction:column;overflow:hidden;}
    .sidebar .card .import-content{flex:1 1 auto;display:none;flex-direction:column;min-height:0;}
    .sidebar .card .import-content.active{display:flex;}
    .sidebar .store-list{flex:1 1 auto;max-height:none;min-height:0;overflow:auto;}
    .card{background:#fff;border:1px solid #d0d5dd;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
    .card h3{color:var(--ink-1);margin-bottom:15px;font-size:1.1em;display:flex;align-items:center;gap:8px;}
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:clamp(10px,1.2vw,18px);}    
    .stat-card{background:var(--gradient-primary);color:#fff;padding:clamp(12px,1.6vw,22px);border-radius:10px;text-align:center;}
    .stat-value{font-size:clamp(1.4rem,2.2vw,2.4rem);font-weight:bold;display:block;}
    .stat-label{font-size:0.9em;opacity:0.9;margin-top:5px;}
    .import-tabs{display:flex;background:#f2f4f7;border-radius:8px;padding:3px;margin-bottom:15px;}
    .import-tab{flex:1;padding:8px 15px;background:transparent;border:none;border-radius:5px;cursor:pointer;font-weight:500;transition:all 0.3s ease;text-align:center;font-size:14px;}
    .import-tab.active{background:var(--pink-1);color:white;}
    .import-tab:hover:not(.active){background:rgba(255,105,180,0.1);}
    .import-content{display:none;}
    .import-content.active{display:block;}
    .upload-area{border:2px dashed #ddd;border-radius:8px;padding:20px;text-align:center;background:#fef5f8;}
    .upload-area:hover{border-color:var(--pink-1);background:#ffe0ec;}
    .upload-area.dragover{border-color:var(--pink-1);background:#ffe0ec;}
    .store-list{max-height:min(38vh,420px);overflow-y:auto;border:1px solid #eee;border-radius:6px;padding:10px;}
    .store-item{display:flex;align-items:center;padding:8px;margin:2px 0;background:#f8f9fa;border-radius:4px;font-size:14px;}
    .store-item input{margin-right:10px;}
    .store-item .info{flex:1;display:flex;align-items:center;gap:10px;}
    .store-item .code{font-weight:bold;min-width:40px;}
    .store-item .name{font-size:12px;color:#444;}
    .rank-badge{background:var(--pink-1);color:#fff;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:500;}
    .rank-badge.rank-aa{background:#FFD700!important;color:#000!important;}
    .rank-badge.rank-a{background:#FF4500!important;color:#fff!important;}
    .rank-badge.rank-b{background:#1E90FF!important;color:#fff!important;}
    .rank-badge.rank-c{background:#32CD32!important;color:#fff!important;}
    .remove-btn{background:var(--danger);color:#fff;border:none;border-radius:3px;padding:3px 6px;cursor:pointer;font-size:11px;}
    .add-store{display:grid;gap:10px;}
    .add-store input,.add-store select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;}
    .queue{max-height:250px;overflow-y:auto;}
    .queue-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;font-size:14px;}
    .queue-item .details{font-size:12px;color:#444;margin-top:2px;}
    .big-button{background:var(--gradient-primary);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .3s ease;}
    .big-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,105,180,.3);}
    .big-button.success{background:var(--gradient-success);} 
    .big-button.warning{background:var(--gradient-warning);} 
    .big-button.danger{background:var(--gradient-danger);}
    .big-button.large{font-size:16px;padding:15px 25px;}
    .big-button:disabled{opacity:0.55;cursor:not-allowed;}
    /* Match specific action buttons to their highlight colors (light mode) */
    #distributeBtn{background:rgba(0,230,118,0.26);color:#1b5e20;border:1px solid rgba(0,230,118,0.55);box-shadow:0 2px 8px rgba(0,230,118,0.22);} 
    #distributeBtn:hover{box-shadow:0 4px 12px rgba(0,230,118,0.34);} 
    #manualAssignBtn{background:rgba(255,235,59,0.28);color:#7a5f00;border:1px solid rgba(255,235,59,0.6);box-shadow:0 2px 8px rgba(255,235,59,0.22);} 
    #manualAssignBtn:hover{box-shadow:0 4px 12px rgba(255,235,59,0.34);} 
    .hidden{display:none;}
    .simple-alert{padding:12px;border-radius:6px;margin:10px 0;font-size:14px;}
    .alert-info{background:#ffe0ec;border:1px solid #ffb6c1;color:var(--ink-1);}
    /* De-emphasize inline strong; themed band added separately */
    #resultsContainer .alert-info > strong{display:none;} 
    .alert-success{background:#ffe6f2;border:1px solid #ffc1dd;color:var(--ink-1);} /* pink-tinted */
    .alert-warning{background:#ffd8ec;border:1px solid #ffb1d8;color:var(--ink-1);} /* softer pink */
    .alert-danger{background:#ffd1e6;border:1px solid #ffa3cf;color:var(--ink-1);} /* deeper pink */
    .store-panes{margin:20px 0;}
    /* Results title header band */
    .results-title{background:var(--pink-1);color:#fff;padding:12px 16px;border-radius:10px;margin:10px 0 10px 0;font-weight:700;font-size:18px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);}
    .results-header-band{background:var(--gradient-primary);color:#fff;padding:12px 16px;border-radius:12px;margin-bottom:12px;display:flex;align-items:center;gap:12px;box-shadow:0 6px 16px rgba(0,0,0,.10);}
    .results-header-title{font-size:1.8em;margin:0;display:flex;align-items:center;gap:12px;color:#fff}
    .step-badge{background:#fff;color:var(--pink-2);width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .step-badge svg{width:22px;height:22px;display:block}
    .store-pane{background:#fff;border:2px solid #d0d5dd;border-radius:12px;margin-bottom:20px;overflow:hidden;}
    .store-pane-header{background:var(--pink-1);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .store-pane-title{font-weight:bold;font-size:18px;display:flex;align-items:center;gap:10px;}
    .store-pane-stats{font-size:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .copy-btn{background:#ffffff;color:#1a1a1a;border:1px solid #e5e7eb;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;}
    .copy-btn:hover{filter:brightness(0.95);} 
    /* Responsive 2-col layout used near actions section */
    .two-col{display:grid;grid-template-columns:2fr 1fr;gap:clamp(12px,1.4vw,24px);}    
    @media (max-width:1100px){.two-col{grid-template-columns:1fr;}}
    .copied-badge{background:#ffeaf4;color:#a80f5f;border:1px solid #ffc8e3;padding:3px 8px;border-radius:9999px;font-size:12px;font-weight:700;}
    .store-pane-body{padding:10px 12px 10px;overflow:auto;max-height:calc(80vh - 220px);position:relative;}    
    /* Disable pseudo fades (replaced by sticky elements below) */
    .store-pane-body.scrollable::before,
    .store-pane-body.scrollable::after{content:none !important}
    /* Sticky scroll fades as real elements so they don't scroll with content */
    .store-pane-body .fade-top,
    .store-pane-body .fade-bottom{position:-webkit-sticky;position:sticky;display:block;height:24px;pointer-events:none;z-index:1;transition:opacity .2s ease;margin-left:-12px;margin-right:-12px}
    .store-pane-body .fade-top{top:-10px;margin-top:0;background:linear-gradient(to bottom, rgba(255,255,255,.95), rgba(255,255,255,0));border-top-left-radius:12px;border-top-right-radius:12px}
    .store-pane-body .fade-bottom{bottom:-10px;margin-bottom:0;background:linear-gradient(to top, rgba(255,255,255,.95), rgba(255,255,255,0));border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    .store-pane-body.at-top .fade-top{opacity:0}
    .store-pane-body.at-bottom .fade-bottom{opacity:0}
    /* Scroll for more pill (sticky at bottom of scroll container) */
    .store-pane-body .scroll-hint{position:-webkit-sticky;position:sticky;bottom:0;display:block;width:max-content;margin:0 auto;padding:3px 10px;border-radius:9999px;font-size:12px;line-height:1;background:rgba(255,255,255,.92);border:1px solid #e5e7eb;color:#374151;box-shadow:0 1px 4px rgba(0,0,0,.08);pointer-events:none;opacity:0;transition:opacity .2s ease;z-index:1}
    .store-pane-body .scroll-hint.show{opacity:1}
    /* Dark mode variants */
    body.dark-mode .store-pane-body .fade-top{background:linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,0))}
    body.dark-mode .store-pane-body .fade-bottom{background:linear-gradient(to top, rgba(0,0,0,.85), rgba(0,0,0,0))}
    body.dark-mode .store-pane-body .scroll-hint{background:rgba(0,0,0,.72);border-color:#333;color:#fce4ec}
    .store-pane-actions{padding:10px 12px 12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;border-top:1px solid #d6dae2;background:#fff;}
    .store-pane-table{width:100%;border-collapse:collapse;}
    /* Sticky headers for issues table */
    .sticky-head thead th{position:sticky;top:0;z-index:2}
    .store-pane-table thead th{background:#f2f4f7}
    body.dark-mode .store-pane-table thead th{background:#222}
    .store-pane-table th{background:#f2f4f7;padding:10px;text-align:left;border-bottom:2px solid #d6dae2;font-weight:600;}
    .store-pane-table td{padding:8px 10px;border-bottom:1px solid #eee;}
    .store-pane-table tr:hover{background:#f1f3f5;}
    .store-pane-table tr:nth-child(even){background:#f5f6f8;}
    .collapse-toggle{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.35);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;}
    .chev{display:inline-block;transition:transform .2s ease;}
    .collapsed .chev{transform:rotate(-90deg);}
    .collapsed .store-pane-body{display:none;}
    /* Light mode: highlighter-style rows on white (green/yellow) */
    .store-pane-table tr.redistributed-row{background:rgba(0,230,118,0.26)!important;}
    .store-pane-table tr.manual-row{background:rgba(255,235,59,0.28)!important;}
    /* Light mode badges (green/yellow) */
    .delta-badge{display:inline-block;margin-left:8px;padding:2px 8px;font-size:11px;border-radius:9999px;font-weight:700;background:#e8f5e8;border:1px solid #c8e6c9;color:#1b5e20;line-height:1.4;vertical-align:middle;}
    .delta-badge.auto{background:#e8f5e8;border:1px solid #c8e6c9;color:#1b5e20;}
    .delta-badge.manual{background:#fff9c4;border:1px solid #ffe082;color:#7a5f00;}
    .legend-note{font-size:12px;color:#2e7d32;margin:8px 0 -4px 0;}
    #fullResultsSection{background:transparent;padding:clamp(16px,1.8vw,28px);margin-top:0;}
    .results-shell{max-width:min(1600px,96vw);margin:0 auto;background:transparent;border-radius:15px;box-shadow:none;padding:clamp(16px,2vw,32px);}    
    #helpOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;}
    .help-content{background:var(--light);border-radius:12px;padding:30px;max-width:600px;max-height:80vh;overflow-y:auto;margin:20px;position:relative;color:var(--ink-1);}
    .help-close{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;font-size:13px;box-shadow:0 8px 20px rgba(0,0,0,.25);opacity:0;pointer-events:none;transform:translateY(10px);transition:opacity .2s ease,transform .2s ease;z-index:9999;}
    .toast.show{opacity:1;transform:translateY(0);}
    .toast-light{background:#f8fafc;color:#111;border:1px solid #e5e7eb;}
    /* Accessible focus */
    :focus-visible{outline:2px solid var(--pink-1);outline-offset:2px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1,1);white-space:nowrap;border:0}
    /* App animations */
    @keyframes fadeInUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeOutDown{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(8px)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{0%{transform:scale(.9);opacity:0}60%{transform:scale(1.03);opacity:1}100%{transform:scale(1)}}
    @keyframes flashBg{0%{box-shadow:0 0 0 0 rgba(255,105,180,.0)}30%{box-shadow:0 0 0 3px rgba(255,105,180,.15)}100%{box-shadow:0 0 0 0 rgba(255,105,180,.0)}}
    .update-flash{animation:flashBg .8s ease}
    .queue-item{animation:fadeInUp .25s ease both}
    .queue-item.removing{animation:fadeOutDown .2s ease both}
    .store-pane{animation:fadeIn .25s ease both}
    .store-pane-body{animation:fadeInUp .25s ease both}
    .store-pane-body tbody tr{animation:fadeIn .2s ease both}
    .delta-badge{animation:popIn .35s ease}
    /* Floating Go-To-Top button */
    .back-to-top{position:fixed;right:28px;bottom:80px;width:44px;height:44px;border-radius:9999px;border:none;cursor:pointer;
      background:var(--gradient-primary);color:#fff;font-weight:700;font-size:18px;display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 20px rgba(0,0,0,.25);opacity:0;pointer-events:none;transform:translateY(10px) scale(.96);
      transition:opacity .2s ease, transform .2s ease, box-shadow .2s ease;z-index:9998}
    .back-to-top.show{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
    .back-to-top:hover{box-shadow:0 12px 28px rgba(0,0,0,.3);transform:translateY(-2px) scale(1.02)}
    body.dark-mode .back-to-top{background:var(--gradient-primary)}
    body.dark-mode{background:linear-gradient(135deg,var(--ink-2) 0%,#000000 100%);color:#fce4ec;}
    body.dark-mode .container{background:#0a0a0a;color:#fce4ec;}
    body.dark-mode .card{background:#1a1a1a;border-color:#333;color:#fce4ec;}
    body.dark-mode .card h3{color:#ffb6c1;}
    body.dark-mode .store-item{background:#222;color:#fce4ec;}
    body.dark-mode .store-item .name{color:#ffb6c1;}
    body.dark-mode .queue-item{background:#222;color:#fce4ec;}
    body.dark-mode .queue-item .details{color:#ffb6c1;}
    body.dark-mode .import-tabs{background:#1a1a1a;}
    body.dark-mode .import-tab{color:#fce4ec;}
    body.dark-mode .import-tab.active{background:var(--pink-1);color:#fff;}
    body.dark-mode .upload-area{background:#1a1a1a;border-color:#333;}
    body.dark-mode .upload-area:hover{background:#222;}
    body.dark-mode input,body.dark-mode select,body.dark-mode textarea{background:#1a1a1a;color:#fce4ec;border-color:#333;}
    body.dark-mode ::placeholder{color:#9e9e9e;}
    body.dark-mode #fullResultsSection{background:transparent;}
    body.dark-mode .results-shell{background:transparent;color:#fce4ec;}
    body.dark-mode .results-title{background:linear-gradient(135deg,#d81b60 0%,#c2185b 100%);}
    body.dark-mode .results-shell h2{color:#ffb6c1;}
    body.dark-mode .store-pane{background:#1a1a1a;border-color:#333;}
    body.dark-mode .store-pane-header{background:var(--gradient-primary);}
    body.dark-mode .store-pane-table th{background:#222;color:#ffb6c1;border-bottom-color:#444;}
    body.dark-mode .store-pane-table td{border-bottom-color:#333;color:#fce4ec;}
    body.dark-mode .store-pane-table tr:hover{background:#222;}
    body.dark-mode .store-pane-table tr:nth-child(even){background:#1a1a1a;}
    body.dark-mode .store-pane-table tr.redistributed-row{background:#1a3d1a!important;}
    body.dark-mode .store-pane-table tr.manual-row{background:#3a3200!important;}
    body.dark-mode .delta-badge{background:#1a3d1a;border-color:#2e5e2e;color:#90ee90;}
    body.dark-mode .delta-badge.auto{background:#1a3d1a;border-color:#2e5e2e;color:#90ee90;}
    body.dark-mode .delta-badge.manual{background:#3a3200;border-color:#665200;color:#ffd54f;}
    body.dark-mode .legend-note{color:#90ee90;}
    body.dark-mode .store-pane-actions{background:#1a1a1a;border-top-color:#333;}
    body.dark-mode .simple-alert{color:#fce4ec;}
    body.dark-mode .alert-info{background:#330a1c;border-color:#d81b60;color:#ffb6c1;}
    body.dark-mode #resultsContainer .alert-info > strong{display:none;}
    body.dark-mode .alert-success{background:#2a0b18;border-color:#5a0f36;color:#ffafd6;}
    body.dark-mode .alert-warning{background:#3a1021;border-color:#7a1746;color:#ffc2dd;}
    body.dark-mode .alert-danger{background:#4a1730;border-color:#9a1f5b;color:#ffd0e8;}
    body.dark-mode .copy-btn{background:#000;color:#ffb6c1;border:1px solid #333;}
    body.dark-mode .copied-badge{background:#2a0b18;border-color:#5a0f36;color:#ffafd6;}
    body.dark-mode .collapse-toggle{background:#000;border-color:#333;color:#fce4ec;}
    body.dark-mode .help-content{background:#1a1a1a;color:#fce4ec;}
    body.dark-mode .help-close{color:#ffb6c1;}
    /* Dark mode: improve Sorting Results title legibility */
    body.dark-mode .results-header-band{background:var(--gradient-primary);} 
    body.dark-mode .results-header-title{color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,.6);} 
    /* Dark mode: buttons also match highlight colors */
    body.dark-mode #distributeBtn{background:#1a3d1a;color:#90ee90;border:1px solid #2e5e2e;box-shadow:0 2px 8px rgba(0,0,0,.25);} 
    body.dark-mode #distributeBtn:hover{box-shadow:0 4px 12px rgba(0,0,0,.3);} 
    body.dark-mode #manualAssignBtn{background:#3a3200;color:#ffd54f;border:1px solid #665200;box-shadow:0 2px 8px rgba(0,0,0,.25);} 
    body.dark-mode #manualAssignBtn:hover{box-shadow:0 4px 12px rgba(0,0,0,.3);} 
    
    @media (max-width:1400px){
      .dashboard{grid-template-columns:clamp(240px,28vw,380px) 1fr;}
    }
    @media (max-width:1100px){
      .dashboard{grid-template-columns:1fr;}
    }
    @media (max-width:900px){
      .store-pane-body{max-height:none;}
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container">
    <div class="header">
      <!-- Abstract banner art -->
      <svg class="header-art" viewBox="0 0 1200 300" preserveAspectRatio="none" aria-hidden="true" focusable="false">
        <defs>
          <linearGradient id="hdr-grad-1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ec4899" stop-opacity="0.90"/>
            <stop offset="100%" stop-color="#f43f5e" stop-opacity="0.70"/>
          </linearGradient>
          <linearGradient id="hdr-grad-3" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f9a8d4" stop-opacity="0.75"/>
            <stop offset="100%" stop-color="#fda4af" stop-opacity="0.50"/>
          </linearGradient>
          <radialGradient id="hdr-grad-2" cx="80%" cy="30%" r="58%">
            <stop offset="0%" stop-color="#fb7185" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#fb7185" stop-opacity="0"/>
          </radialGradient>
          <filter id="blur-12">
            <feGaussianBlur stdDeviation="8"/>
          </filter>
          <filter id="blur-20">
            <feGaussianBlur stdDeviation="16"/>
          </filter>
        </defs>

        <!-- Pink ribbon sweep (primary) -->
        <path d="M0,230 C240,160 420,185 660,140 C880,100 1040,120 1200,70 L1200,0 L0,0 Z"
              fill="url(#hdr-grad-1)" filter="url(#blur-12)"/>

        <!-- Secondary ribbon for extra depth -->
        <path d="M0,200 C200,150 420,150 740,120 C980,100 1120,80 1200,50 L1200,0 L0,0 Z"
              fill="url(#hdr-grad-3)" opacity="0.85"/>

        <!-- Soft green glow tying to highlight theme -->
        <circle cx="980" cy="60" r="260" fill="url(#hdr-grad-2)" filter="url(#blur-20)"/>

        <!-- Subtle drift circles -->
        <g fill="#ffffff" opacity="0.16">
          <circle cx="110" cy="90" r="28"/>
          <circle cx="240" cy="60" r="18"/>
          <circle cx="360" cy="110" r="22"/>
          <circle cx="520" cy="70" r="14"/>
          <circle cx="720" cy="95" r="16"/>
          <circle cx="860" cy="50" r="12"/>
        </g>

        <!-- Light stroke accents -->
        <g fill="none" stroke="#ffffff" stroke-opacity="0.20" stroke-width="2.5">
          <path d="M0,190 C260,140 480,170 720,120 C920,78 1080,92 1200,60"/>
          <path d="M0,240 C200,200 440,210 680,170 C900,134 1080,140 1200,120"/>
          <path d="M0,165 C180,130 360,140 600,120 C860,96 1050,102 1200,80"/>
        </g>
      </svg>
      <div class="help-button">
        <button onclick="showHelpOverlay()" title="Show help guide">❓ Help</button>
      </div>
      <h1>Allocation Buddy</h1>
      <p>Compact dashboard for sorting inventory by store destination</p>
      <div class="dark-mode-toggle">
        <span class="toggle-icon" id="modeIcon">🌙</span>
        <div class="toggle-switch" onclick="toggleDarkMode()" id="toggleSwitch" aria-label="Toggle dark mode"></div>
      </div>
    </div>

    <div class="dashboard">
      <div class="sidebar">
        <div class="card">
          <h3>🪪 Store Management</h3>
          <div class="import-tabs">
            <button class="import-tab active" onclick="switchTab('store','manage')">📋 Manage Stores</button>
            <button class="import-tab" onclick="switchTab('store','add')">➕ Add Store</button>
          </div>

          <div class="import-content active" id="manage-content">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;font-size:14px;">
              <span>Active: <strong id="activeStoreCount">0</strong></span>
              <span>Inactive: <strong id="inactiveStoreCount">0</strong></span>
              <div>
                <button class="big-button" onclick="toggleAllStores(true)" style="padding:4px 8px;font-size:12px;margin-right:5px;">All</button>
                <button class="big-button" onclick="toggleAllStores(false)" style="padding:4px 8px;font-size:12px;">None</button>
              </div>
            </div>
            <div class="store-list" id="storeStatusContainer"></div>
          </div>

          <div class="import-content" id="add-content">
            <div class="add-store">
              <input type="text" id="newStoreCode" placeholder="Store Code"/>
              <input type="text" id="newStoreName" placeholder="Store Name"/>
              <select id="newStoreRank">
                <option value="AA">AA - Above A</option>
                <option value="A">A - High</option>
                <option value="B" selected>B - Medium</option>
                <option value="C">C - Low</option>
              </select>
              <label style="display:flex;align-items:center;gap:8px;font-size:14px;">
                <input type="checkbox" id="newStoreActive" checked/> Start as active
              </label>
              <button class="big-button success" onclick="addNewStore()">Add Store</button>

              <!-- New: Re-add default stores button -->
              <button class="big-button warning" onclick="restoreDefaults()" style="margin-top:10px;">
                Re-Add Default Stores
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="main-area">
        <div class="stats-row">
          <div class="stat-card"><span class="stat-value" id="itemCount">0</span><div class="stat-label">Items to Sort</div></div>
          <div class="stat-card"><span class="stat-value" id="storeDestinationCount">0</span><div class="stat-label">Destinations</div></div>
          <div class="stat-card"><span class="stat-value" id="activeStoreCount2">0</span><div class="stat-label">Active Stores</div></div>
          <div class="stat-card"><span class="stat-value" id="totalProcessed">0</span><div class="stat-label">Processed</div></div>
        </div>

        <div class="card">
          <h3>📤 Import Data</h3>
          <div class="import-tabs">
            <button class="import-tab active" onclick="switchTab('import','upload')">📄 Upload Excel</button>
            <button class="import-tab" onclick="switchTab('import','paste')">📋 Paste Data</button>
          </div>

          <div class="import-content active" id="upload-content">
            <div class="upload-area" id="uploadArea">
              <h4>Upload Excel File</h4>
              <p style="margin:10px 0;font-size:14px;color:#666;">Choose .xlsx, .xlsm, or .xls files</p>
              <p style="margin:5px 0;font-size:12px;color:#888;">✨ Supports store codes OR store names</p>
              <input type="file" id="fileInput" accept=".xlsx,.xlsm,.xls" onchange="handleFileUpload(event)" style="display:none;"/>
              <button class="big-button" onclick="document.getElementById('fileInput').click()">Choose File</button>
              <label style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:10px;font-size:12px;color:#555">
                <input type="checkbox" id="combineToggle"/> Combine duplicate item-store lines on import
              </label>
              <div id="fileStatus" style="font-size:12px;margin-top:10px;"></div>
            </div>
          </div>

          <div class="import-content" id="paste-content">
            <div style="text-align:center;margin-bottom:15px;">
              <h4>Paste Data</h4>
              <p style="font-size:14px;color:#666;margin:5px 0;">Copy from Excel and paste below</p>
              <p style="font-size:12px;color:#888;">Format: ItemNumber, Quantity, StoreCode/StoreName</p>
            </div>
            <textarea id="pasteArea" placeholder="Example:&#10;NSN-0402-21, 10, 101&#10;NSN-0405-04, 20, NIAGARA 1&#10;NSN-0405-05, 15, MISSISSAUGA" style="width:100%;height:100px;font-size:12px;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;"></textarea>
            <label style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;font-size:12px;color:#555">
              <input type="checkbox" id="combineToggle2"/> Combine duplicate item-store lines on import
            </label>
            <button class="big-button success" onclick="processPastedData()" style="margin-top:8px;width:100%;">Process Data</button>
          </div>
        </div>

        <div class="two-col">
          <div class="card">
            <h3>📦 Import Queue</h3>
            <div class="queue" id="importContainer">
              <div class="simple-alert alert-info">No items imported yet.</div>
            </div>
            <button class="big-button danger hidden" onclick="clearImport()" id="clearBtn" style="margin-top:10px;">Clear All</button>
          </div>

          <div class="card">
            <h3>🚀 Actions</h3>
            <div id="sortingStatus" style="margin-bottom:15px;"></div>
            <button class="big-button success large" onclick="sortItems()" style="width:100%;margin-bottom:10px;">Sort by Store</button>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <button class="big-button" onclick="exportResults()">Export</button>
              <button class="big-button warning" onclick="startOver()">Reset</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="fullResultsSection" class="hidden">
      <div class="results-shell">
        <div class="results-header-band">
          <h2 class="results-header-title">
            <span class="step-badge" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 7V17 M10 17 L7 14 M10 17 L13 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 17V7 M14 7 L11 10 M14 7 L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            Sorting Results
          </h2>
        </div>
      <div id="resultsStatus" style="margin-bottom:10px;"></div>
      <div id="issuesContainer" class="hidden"></div>
      <div id="resultsContainer"></div>
    </div>
  </div>

  <!-- Help Overlay -->
  <div id="helpOverlay" style="display:none;">
    <div class="help-content">
      <button onclick="hideHelpOverlay()" class="help-close">×</button>
      
      <h2 style="color:var(--pink-1);margin-bottom:20px;">📚 Allocation Buddy Help</h2>
      
      <div style="line-height:1.6;">
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🪪 Store Management</h3>
        <p>Manage your store list with codes, names, and priority ranks (AA=Above A, A=High, B=Medium, C=Low). Toggle stores active/inactive and add new stores as needed.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">📤 Import Data</h3>
        <p><strong>Excel Upload:</strong> Upload .xlsx/.xls files with Item, Quantity, and Store columns. Auto-detects headers and supports both store codes and store names.</p>
        <p><strong>Paste Data:</strong> Copy from Excel and paste. Format: ItemNumber, Quantity, StoreCode/StoreName (comma or tab separated).</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🚀 Sort & Distribute</h3>
        <p><strong>Sort by Store:</strong> Organizes items by destination and identifies issues (inactive stores, missing stores).</p>
        <p><strong>Manual Assign Selected → Re-Sort:</strong> For each problem row, choose a target store from the dropdown, then apply and re-sort.</p>
        <p><strong>Auto-Distribute Problems → Active (by Rank):</strong> Automatically redistributes items from inactive or unknown stores to active ones using rank-weighted distribution.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">📋 Copy & Export</h3>
        <p><strong>Copy Store Items:</strong> Click 📋 Copy to copy item lists (Tab-separated). Hold Alt for CSV format.</p>
        <p><strong>Export:</strong> Download complete results as Excel file with separate sheets for stores and issues.</p>
        
        <h3 style="color:var(--pink-1);margin:20px 0 10px 0;">🌙 Features</h3>
        <p>• Dark/Light mode toggle<br>• Collapsible store sections<br>• Real-time validation<br>• Rank-weighted redistribution<br>• Automatic store detection by code or name</p>
        
        <div class="pro-tip">
          <strong>💡 Pro Tip:</strong> Items assigned to inactive or unknown stores will be flagged. Use "Distribute Problem → Active" to automatically reallocate them based on store priority ranks.
        </div>
      </div>
    </div>
  </div>

  <div id="copyToast" class="toast">Copied!</div>
  <div id="actionToast" class="toast" style="left:50%;transform:translate(-50%,10px);right:auto;bottom:24px;">Action done. <button id="undoBtn" class="copy-btn" style="margin-left:8px;">Undo</button></div>
  <div id="ariaStatus" class="sr-only" aria-live="polite"></div>

  <!-- Go To Top Button -->
  <button id="backToTopBtn" class="back-to-top" aria-label="Go to top" title="Go to top">↑</button>

  <!-- Footer -->
  <footer class="footer">
    <div>
      <strong>Allocation Buddy</strong> - Inventory Management System
    </div>
    <div style="margin-top:8px;font-size:12px;opacity:0.8;">
      Copyright © 2025. All rights reserved. | Designed for efficient inventory allocation and distribution management.
    </div>
  </footer>

  <script>
    // Cache DOM elements
    const $ = id => document.getElementById(id);
    const $$ = sel => document.querySelector(sel);
    const $$$ = sel => document.querySelectorAll(sel);
    
    // Constants
    const RANK_WEIGHTS = { AA: 4, A: 3, B: 2, C: 1 };
    const COOKIE_NAME = 'allocationBuddyPrefs';
    const COOKIE_DAYS = 365;
    const APP_STATE_KEY = 'allocationBuddyStateV1';

    // ---------- Defaults & helpers ----------
    const DEFAULT_STORES = Object.freeze([
      {code:'101',name:'WATERLOO 1',rank:'C',active:true},
      {code:'102',name:'KITCHENER 1',rank:'B',active:true},
      {code:'103',name:'CAMBRIDGE',rank:'B',active:true},
      {code:'104',name:'LONDON 1',rank:'B',active:true},
      {code:'105',name:'LONDON 2',rank:'B',active:true},
      {code:'106',name:'HAMILTON 1',rank:'C',active:true},
      {code:'107',name:'MISSISSAUGA',rank:'A',active:true},
      {code:'108',name:'ST CATHARINES',rank:'B',active:true},
      {code:'109',name:'HAMILTON 2',rank:'A',active:true},
      {code:'110',name:'TORONTO 1',rank:'A',active:true},
      {code:'111',name:'SCARBOROUGH',rank:'A',active:true},
      {code:'112',name:'WINDSOR 1',rank:'A',active:true},
      {code:'114',name:'TORONTO 2',rank:'A',active:true},
      {code:'115',name:'KITCHENER 2',rank:'C',active:true},
      {code:'116',name:'BRANTFORD',rank:'C',active:true},
      {code:'117',name:'NIAGARA 1',rank:'B',active:false},
      {code:'118',name:'BURLINGTON',rank:'A',active:true},
      {code:'119',name:'LONDON 3',rank:'B',active:true},
      {code:'120',name:'BARRIE 1',rank:'A',active:true},
      {code:'121',name:'OSHAWA',rank:'A',active:true},
      {code:'122',name:'BARRIE 2',rank:'A',active:true},
      {code:'123',name:'GUELPH',rank:'B',active:true},
      {code:'125',name:'TORONTO 3',rank:'A',active:true},
      {code:'126',name:'NIAGARA 2',rank:'C',active:true},
      {code:'127',name:'SARNIA',rank:'C',active:true},
      {code:'128',name:'OTTAWA 1',rank:'C',active:true},
      {code:'129',name:'OTTAWA 2',rank:'C',active:true},
      {code:'130',name:'TORONTO 4',rank:'A',active:true},
      {code:'131',name:'SUDBURY',rank:'B',active:true},
      {code:'132',name:'WINDSOR 2',rank:'B',active:true},
      {code:'133',name:'ST JOHNS',rank:'A',active:true},
      {code:'134',name:'PETERBOROUGH',rank:'B',active:true},
      {code:'135',name:'THUNDER BAY',rank:'A',active:true},
      {code:'199',name:'STAG WEB',rank:'AA',active:true}
    ]);
    const cloneDefaults = () => DEFAULT_STORES.map(s => ({...s}));

    // State
    let itemsToSort = [];
    let lastResults = null;
    let redistributionDeltas = {};
    let currentWorkbook = null;
    const collapsedStores = {};
    const copiedStores = {};
    let allStores = cloneDefaults(); // start from defaults
    let appStateLoaded = false;

    // Virtualization settings and state
    const IMPORT_CHUNK = 300;
    const RESULTS_STORE_CHUNK = 50;
    const RESULTS_ITEMS_CHUNK = 300;
    let importRenderLimit = IMPORT_CHUNK;
    let resultsStoreRenderLimit = RESULTS_STORE_CHUNK;
    const expandedStoreItems = {}; // storeCode -> true when expanded

    // Fast store lookups (O(1) by code or exact name)
    const storeIndex = {
      byCode: new Map(),
      byNameUpper: new Map()
    };
    const rebuildStoreIndex = () => {
      storeIndex.byCode.clear();
      storeIndex.byNameUpper.clear();
      allStores.forEach(s => {
        s._codeNum = parseInt(String(s.code));
        if (!Number.isFinite(s._codeNum)) s._codeNum = 999999;
        storeIndex.byCode.set(String(s.code), s);
        storeIndex.byNameUpper.set(String(s.name).toUpperCase(), s);
      });
    };
    const getStoreByCode = code => storeIndex.byCode.get(String(code));
    const getStoreByNameUpper = nameUpper => storeIndex.byNameUpper.get(String(nameUpper).toUpperCase());
    // Initialize index on load
    rebuildStoreIndex();

    // Utilities
    const setCookie = (name, value, days = COOKIE_DAYS) => {
      const date = new Date();
      date.setTime(date.getTime() + (days * 864e5));
      document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${date.toUTCString()};path=/;SameSite=Strict`;
    };

    const getCookie = name => {
      const nameEQ = name + "=";
      return document.cookie.split(';').reduce((acc, c) => {
        const cookie = c.trim();
        if (cookie.startsWith(nameEQ)) {
          try { return JSON.parse(decodeURIComponent(cookie.substring(nameEQ.length))); }
          catch(e) { return null; }
        }
        return acc;
      }, null);
    };

    // ---------- Persistent App State (localStorage) ----------
    const saveAppState = () => {
      try {
        const state = {
          v: 1,
          darkMode: document.body.classList.contains('dark-mode'),
          allStores,
          itemsToSort,
          lastResults,
          redistributionDeltas,
          collapsedStores,
          copiedStores
        };
        localStorage.setItem(APP_STATE_KEY, JSON.stringify(state));
      } catch (e) {
        // ignore quota or serialization errors
      }
    };

    const loadAppState = () => {
      try {
        const raw = localStorage.getItem(APP_STATE_KEY);
        if (!raw) return false;
        const state = JSON.parse(raw);
        if (!state || typeof state !== 'object') return false;

        if (Array.isArray(state.allStores) && state.allStores.length > 0) {
          allStores = state.allStores.map(s => ({...s}));
        }
        rebuildStoreIndex();

        if (Array.isArray(state.itemsToSort)) itemsToSort = state.itemsToSort.map(x => ({...x}));
        lastResults = state.lastResults || null;
        redistributionDeltas = state.redistributionDeltas || {};

        // Merge into existing objects
        if (state.collapsedStores && typeof state.collapsedStores === 'object') Object.assign(collapsedStores, state.collapsedStores);
        if (state.copiedStores && typeof state.copiedStores === 'object') Object.assign(copiedStores, state.copiedStores);

        // Dark mode (from state)
        if (typeof state.darkMode === 'boolean') {
          document.body.classList.toggle('dark-mode', state.darkMode);
          $('toggleSwitch').classList.toggle('active', state.darkMode);
          $('modeIcon').textContent = state.darkMode ? '🌙' : '☀️';
        }

        // Reflect to UI
        updateStoreStatus();
        updateImportDisplay();
        if (lastResults?.sortedStores?.length) {
          const section = $('fullResultsSection');
          section.classList.remove('hidden');
          displayResults(lastResults);
          $('totalProcessed').textContent = (lastResults.validItems?.length || 0) + (lastResults.issues?.length || 0);
        }
        updateDistributeButtonState();
        appStateLoaded = true;
        return true;
      } catch (e) { return false; }
    };

    const clearAppState = () => {
      try { localStorage.removeItem(APP_STATE_KEY); } catch(e) {}
    };

    const getCodeNumFromObj = (obj) => {
      if (!obj) return 999999;
      if (Object.prototype.hasOwnProperty.call(obj, '_codeNum')) return obj._codeNum;
      const codeLike = obj.code ?? obj.storeCode;
      const n = parseInt(String(codeLike));
      return Number.isFinite(n) ? n : 999999;
    };
    const sortStoresNumerically = arr => arr.slice().sort((a, b) => getCodeNumFromObj(a) - getCodeNumFromObj(b));

    const findStoreByCodeOrName = identifier => {
      if (!identifier) return null;
      const searchStr = String(identifier).trim();
      const byCode = getStoreByCode(searchStr);
      if (byCode) return byCode;
      const upper = searchStr.toUpperCase();
      const byName = getStoreByNameUpper(upper);
      if (byName) return byName;
      // Fallback: partial match (O(n))
      for (const s of storeIndex.byNameUpper.values()) {
        if (String(s.name).toUpperCase().includes(upper)) return s;
      }
      return null;
    };

    const showStatus = (html, type = 'info') => {
      const alertClass = `alert-${type}`;
      const block = `<div class="simple-alert ${alertClass}">${html}</div>`;
      const statusElements = [$('sortingStatus'), $('resultsStatus')].filter(Boolean);
      statusElements.forEach(el => el.innerHTML = block);
    };

    const saveUserPreferences = () => {
      const preferences = {
        darkMode: document.body.classList.contains('dark-mode'),
        storeStates: allStores.map(s => ({code: s.code, active: s.active}))
      };
      setCookie(COOKIE_NAME, preferences);
    };

    const getActiveImportTab = () => {
      const activeTab = $('.main-area .import-tab.active')?.textContent;
      if (activeTab?.includes('Upload')) return 'upload';
      if (activeTab?.includes('Paste')) return 'paste';
      if (activeTab?.includes('How to Use')) return 'info';
      return 'upload';
    };

    const loadUserPreferences = () => {
      const prefs = getCookie(COOKIE_NAME);
      if (!prefs) return;

      // Dark mode
      if (prefs.darkMode !== undefined) {
        const isDark = prefs.darkMode;
        document.body.classList.toggle('dark-mode', isDark);
        $('toggleSwitch').classList.toggle('active', isDark);
        $('modeIcon').textContent = isDark ? '🌙' : '☀️';
      }

      // Store states (only apply active flags if they match existing codes)
      if (!appStateLoaded && Array.isArray(prefs.storeStates)) {
        const codes = new Set(allStores.map(s => s.code));
        prefs.storeStates.forEach(savedStore => {
          if (codes.has(savedStore.code)) {
            const store = getStoreByCode(savedStore.code);
            if (store) store.active = !!savedStore.active;
          }
        });
      }

      // Do not restore tabs from preferences; keep HTML defaults
    };

    // Help functions
    const showHelpOverlay = () => {
      $('helpOverlay').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };

    const hideHelpOverlay = () => {
      $('helpOverlay').style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    // Tab management
    const switchTab = (section, tabName, save = true) => {
      const isStore = section === 'store';
      const container = isStore ? '.sidebar .card' : '.main-area .card';
      const tabs = $$$(`${container} .import-tab`);
      const contents = $$$(`${container} .import-content`);
      
      tabs.forEach(tab => tab.classList.remove('active'));
      contents.forEach(content => content.classList.remove('active'));
      
      const activeIndex = (isStore && tabName === 'add') || (!isStore && tabName === 'paste') ? 1 : 0;
      tabs[activeIndex]?.classList.add('active');
      $(`${tabName}-content`)?.classList.add('active');
      
      if (save) saveUserPreferences();
    };

    // Store management
    const updateStoreCounts = () => {
      const active = allStores.filter(s => s.active).length;
      const inactive = allStores.length - active;
      $('activeStoreCount').textContent = $('activeStoreCount2').textContent = active;
      $('inactiveStoreCount').textContent = inactive;
    };

    const updateStoreStatus = () => {
      updateStoreCounts();
      const cont = $('storeStatusContainer');
      cont.innerHTML = sortStoresNumerically(allStores)
        .map(store => `
          <div class="store-item">
            <input type="checkbox" ${store.active ? 'checked' : ''} onchange="toggleStoreStatus('${store.code}', this.checked)"/>
            <div class="info">
              <span class="code">${store.code}</span>
              <span class="name">${store.name}</span>
              <span class="rank-badge rank-${store.rank.toLowerCase()}">${store.rank}</span>
            </div>
            <button class="remove-btn" onclick="removeStore('${store.code}')">×</button>
          </div>`)
        .join('');
      cont.classList.add('update-flash');
      setTimeout(()=>cont.classList.remove('update-flash'), 400);
      updateDistributeButtonState();
      if (typeof syncSidebarToQueue === 'function') syncSidebarToQueue();
    };

    const toggleStoreStatus = (storeCode, isActive) => {
      const store = getStoreByCode(storeCode);
      if (store) {
        store.active = isActive;
        updateStoreCounts();
        saveUserPreferences();
        saveAppState();
        updateDistributeButtonState();
      }
    };

    const toggleAllStores = active => {
      allStores.forEach(s => s.active = active);
      updateStoreStatus();
      saveUserPreferences();
      saveAppState();
    };

    const removeStore = storeCode => {
      if (confirm(`Delete store ${storeCode}?`)) {
        allStores = allStores.filter(s => s.code !== storeCode);
        rebuildStoreIndex();
        updateStoreStatus();
        updateDistributeButtonState();
        saveUserPreferences();
        saveAppState();
      }
    };

    const addNewStore = () => {
      const code = $('newStoreCode').value.trim();
      const name = $('newStoreName').value.trim();
      const rank = $('newStoreRank').value;
      const active = $('newStoreActive').checked;
      
      if (!code || !name) { alert('Please enter both code and name'); return; }
      if (getStoreByCode(code)) { alert('Store code already exists'); return; }
      
      allStores.push({code, name: name.toUpperCase(), rank, active});
      rebuildStoreIndex();
      ['newStoreCode', 'newStoreName'].forEach(id => $(id).value = '');
      $('newStoreRank').value = 'B';
      $('newStoreActive').checked = true;
      updateStoreStatus();
      switchTab('store', 'manage');
      updateDistributeButtonState();
      saveUserPreferences();
      saveAppState();
    };

    // New: re-add default stores on demand
    const restoreDefaults = () => {
      if (!confirm('Re-add all default stores? This will overwrite your current list.')) return;
      allStores = cloneDefaults();
      rebuildStoreIndex();
      // clear stale prefs so defaults persist on reload
      document.cookie = "allocationBuddyPrefs=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Strict";
      updateStoreStatus();
      updateDistributeButtonState();
      saveUserPreferences();
      showStatus('<strong>✅ Default stores restored.</strong>', 'success');
      saveAppState();
    };

    // Import handling
    const handleFileUpload = event => {
      const file = event.target.files[0];
      if (!file) return;
      $('fileStatus').innerHTML = '📊 Reading file...';
      importFile(file);
    };

    // Saved column mappings per sheet
    const COLMAP_KEY = 'allocationBuddyColMapV1';
    const getSavedMappingForSheet = (sheetName) => {
      try { const all = JSON.parse(localStorage.getItem(COLMAP_KEY) || '{}'); return all && all[sheetName] ? all[sheetName] : null; } catch(e){ return null; }
    };
    const saveMappingForSheet = (sheetName, mapping) => {
      try { const all = JSON.parse(localStorage.getItem(COLMAP_KEY) || '{}'); all[sheetName] = mapping; localStorage.setItem(COLMAP_KEY, JSON.stringify(all)); } catch(e){}
    };
    const applySavedMappingIfAny = () => {
      const sel = $('sheetSelector'); if (!sel) return;
      const name = sel.value; const map = getSavedMappingForSheet(name);
      if (map) { importFromSheet(name, map); } else { $('fileStatus').innerHTML += '<div style="font-size:12px;color:#888;margin-top:6px;">No saved mapping for this sheet.</div>'; }
    };

    const importFile = (file) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          currentWorkbook = XLSX.read(new Uint8Array(e.target.result), {type:'array', cellDates: true, dateNF: 'yyyy-mm-dd'});
          if (currentWorkbook.SheetNames.length === 1) {
            importFromSheet(currentWorkbook.SheetNames[0]);
          } else {
            showSheetSelector();
          }
        } catch (err) {
          $('fileStatus').innerHTML = `❌ Error reading file: ${err.message}`;
        }
      };
      reader.readAsArrayBuffer(file);
    };

    const showSheetSelector = () => {
      const options = currentWorkbook.SheetNames.map(name => `<option value="${name}">${name}</option>`).join('');
      $('fileStatus').innerHTML = `
        <div style="margin: 10px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Sheet to Import:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="sheetSelector" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">${options}</select>
            <button class="big-button" onclick="importSelectedSheet()" style="padding: 6px 12px; font-size: 12px;">Import</button>
          </div>
          <button class="big-button" onclick="showColumnMapper()" style="margin-top: 8px; width: 100%; font-size: 12px;">Advanced Import (Column Mapping)</button>
          <button class="big-button" onclick="applySavedMappingIfAny()" style="margin-top: 6px; width: 100%; font-size: 12px;">Use Saved Mapping (if available)</button>
        </div>`;
    };

    const importSelectedSheet = () => $('sheetSelector') && importFromSheet($('sheetSelector').value);

    // Keep unknown stores instead of skipping
    const importFromSheet = (sheetName, columnMapping = null) => {
      try {
        let debugOutput = '';

        const rows = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[sheetName], {header:1, defval:'', raw: false});
        if (rows.length === 0) {
          $('fileStatus').innerHTML = '⚠️ Sheet is empty';
          return;
        }

        let headerRow = -1, itemCol = 0, qtyCol = 1, storeCol = 2;
        
        if (!columnMapping) {
          // Try saved mapping first
          const savedMap = getSavedMappingForSheet(sheetName);
          if (savedMap) { ({itemCol, qtyCol, storeCol, headerRow} = savedMap); debugOutput += `<div style="font-size:11px;color:#888;margin-top:6px;">Used saved column mapping for "${sheetName}"</div>`; }
          for (let i = 0; i < Math.min(5, rows.length); i++) {
            const row = rows[i];
            const itemPatterns = /(item|style|item\s*no|item\s*number)/i;
            const qtyPatterns = /(qty|quantity|allocations)/i;
            
            let foundItem = false, foundQty = false, foundStore = false;
            
            row.forEach((cell, idx) => {
              const cellStr = String(cell).toLowerCase().trim();
              if (itemPatterns.test(cellStr) && !foundItem) { itemCol = idx; foundItem = true; }
              if (qtyPatterns.test(cellStr) && !foundQty)  { qtyCol  = idx; foundQty  = true; }
              if (!foundStore) {
                if (/^\d{3}$/.test(cellStr)) { storeCol = idx; foundStore = true; }
                else if (/(store|location|dest|code)/i.test(cellStr)) { storeCol = idx; foundStore = true; }
              }
            });
            
            if (foundItem || foundQty) { headerRow = i; break; }
            if (foundStore && !foundItem && !foundQty && i === 0) { headerRow = -1; break; }
          }
          
          if (headerRow === -1 && rows.length > 0) {
            rows[0].forEach((cell, idx) => { if (/^\d{3}$/.test(String(cell).trim())) storeCol = idx; });
          }
        } else {
          ({itemCol, qtyCol, storeCol, headerRow} = columnMapping);
          // persist mapping
          saveMappingForSheet(sheetName, columnMapping);
        }

        let imported = 0, skipped = 0;
        const errors = [];
        
        rows.forEach((row, idx) => {
          if (idx <= headerRow) return;
          
          const itemNumber = String(row[itemCol] || '').trim();
          const quantityRaw = row[qtyCol];
          const storeIdentifierRaw = String(row[storeCol] || '').trim();
          const storeIdentifier = storeIdentifierRaw.replace(/^0+/, '');
          
          let quantity = typeof quantityRaw === 'number' ? quantityRaw : 
            parseFloat(String(quantityRaw).replace(/[^\d.-]/g, ''));
          
          if (!itemNumber || !Number.isFinite(quantity) || quantity <= 0 || !storeIdentifier) {
            if (itemNumber || quantityRaw || storeIdentifier) {
              skipped++; errors.push(`Row ${idx + 1}: Invalid data`);
            }
            return;
          }
          
          const store = findStoreByCodeOrName(storeIdentifier);
          if (!store) {
            itemsToSort.push({
              itemNumber: itemNumber.toUpperCase(),
              quantity: Math.floor(quantity),
              storeCode: storeIdentifier,
              source: `Excel (${sheetName})`
            });
            imported++;
            return;
          }
          
          itemsToSort.push({
            itemNumber: itemNumber.toUpperCase(),
            quantity: Math.floor(quantity),
            storeCode: store.code,
            source: `Excel (${sheetName})`
          });
          imported++;
        });

        let statusMsg = `✅ Imported ${imported} items from "${sheetName}"`;
        if (skipped > 0) {
          statusMsg += ` (${skipped} rows skipped)`;
          if (errors.length <= 5) {
            statusMsg += `<div style="font-size: 11px; color: #666; margin-top: 5px;">Issues: ${errors.join('; ')}</div>`;
          } else if (errors.length > 5) {
            statusMsg += `<div style="font-size: 11px; color: #666; margin-top: 5px;">${errors.length} rows had issues</div>`;
          }
        }
        
        statusMsg += debugOutput;
        
        $('fileStatus').innerHTML = statusMsg;
        updateImportDisplay();
        if (shouldCombineDuplicates && shouldCombineDuplicates()) combineAllDuplicates();
        saveAppState();
      } catch (err) {
        $('fileStatus').innerHTML = `❌ Import error: ${err.message}`;
      }
    };

    const showColumnMapper = () => {
      const sheetName = $('sheetSelector').value;
      const rows = XLSX.utils.sheet_to_json(currentWorkbook.Sheets[sheetName], {header:1, defval:'', raw: false});
      if (rows.length === 0) return;
      
      const previewRows = rows.slice(0, 5);
      $('fileStatus').innerHTML = `
        <div style="margin: 10px 0;">
          <h4>Column Mapping for "${sheetName}"</h4>
          <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin: 8px 0; max-height: 150px; overflow: auto;">
            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
              ${previewRows.map((row, idx) => `
                <tr style="border-bottom: 1px solid #ddd;">
                  <td style="padding: 2px 4px; font-weight: bold; background: #eee;">${idx + 1}</td>
                  ${row.slice(0, 10).map((cell, colIdx) => `
                    <td style="padding: 2px 4px;" title="Column ${String.fromCharCode(65 + colIdx)}: ${String(cell)}">${String(cell).substring(0, 15)}</td>
                  `).join('')}
                </tr>
              `).join('')}
            </table>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 8px 0;">
            ${['Item', 'Quantity', 'Store'].map((label, i) => `
              <div>
                <label style="font-size: 12px; font-weight: 500;">${label} Column:</label>
                <select id="${['item', 'qty', 'store'][i]}ColSelect" style="width: 100%; padding: 4px;">
                  ${rows[0].map((_, idx) => `<option value="${idx}" ${idx === i ? 'selected' : ''}>Column ${String.fromCharCode(65 + idx)} (${String(rows[0][idx]).substring(0, 10)})</option>`).join('')}
                </select>
                ${i === 2 ? '<div style="font-size: 10px; color: #666; margin-top: 2px;">Accepts store codes or names</div>' : ''}
              </div>
            `).join('')}
          </div>
          <div style="margin: 8px 0;">
            <label style="font-size: 12px; font-weight: 500;">Header Row (skip this many rows):</label>
            <input type="number" id="headerRowInput" value="0" min="0" max="10" style="width: 60px; padding: 4px;">
          </div>
          <button class="big-button success" onclick="importWithMapping()" style="width: 100%; font-size: 12px;">Import with Custom Mapping</button>
        </div>`;
    };

    const importWithMapping = () => {
      const columnMapping = {
        itemCol: parseInt($('itemColSelect').value),
        qtyCol: parseInt($('qtyColSelect').value),
        storeCol: parseInt($('storeColSelect').value),
        headerRow: parseInt($('headerRowInput').value) - 1
      };
      importFromSheet($('sheetSelector').value, columnMapping);
    };

    const processPastedData = () => {
      const pasteData = $('pasteArea').value.trim();
      if (!pasteData) { alert('Please paste some data first'); return; }
      
      const lines = pasteData.split('\n').filter(line => line.trim());
      let imported = 0, skipped = 0;
      const errors = [];
      
      lines.forEach((line, idx) => {
        const parts = (line.includes('\t') ? line.split('\t') : line.split(',')).map(p => p.trim()).filter(p => p);
        if (parts.length < 3) {
          skipped++;
          errors.push(`Line ${idx + 1}: Insufficient data`);
          return;
        }
        
        const [itemNumber, quantityStr, storeIdentifier] = parts;
        const quantity = parseInt(quantityStr, 10);
        
        if (!itemNumber || !Number.isFinite(quantity) || quantity <= 0 || !storeIdentifier) {
          skipped++;
          errors.push(`Line ${idx + 1}: Invalid data`);
          return;
        }
        
        const store = findStoreByCodeOrName(storeIdentifier);
        if (!store) {
          itemsToSort.push({itemNumber, quantity, storeCode: storeIdentifier, source:'Paste'});
          imported++;
          return;
        }
        
        itemsToSort.push({itemNumber, quantity, storeCode: store.code, source:'Paste'});
        imported++;
      });
      
      if (imported > 0) {
        $('pasteArea').value = '';
        updateImportDisplay();
        if (shouldCombineDuplicates && shouldCombineDuplicates()) combineAllDuplicates();
        saveAppState();
        let message = `✅ Added ${imported} items`;
        if (skipped > 0) {
          message += ` (${skipped} rows skipped)`;
          if (errors.length <= 3) message += `\n\nSkipped: ${errors.join('; ')}`;
        }
        alert(message);
      } else {
        alert(`No valid items found${errors.length > 0 ? `\n\nErrors: ${errors.slice(0, 5).join('; ')}` : ''}`);
      }
    };

    const updateImportDisplay = () => {
      $('itemCount').textContent = itemsToSort.length;
      $('storeDestinationCount').textContent = [...new Set(itemsToSort.map(item => item.storeCode))].length;
      
      const clearBtn = $('clearBtn');
      if (itemsToSort.length === 0) {
        $('importContainer').innerHTML = '<div class="simple-alert alert-info">No items imported yet.</div>';
        clearBtn.classList.add('hidden');
        updateDistributeButtonState();
        return;
      }
      
      clearBtn.classList.remove('hidden');
      if (!Number.isFinite(importRenderLimit) || importRenderLimit < 1) importRenderLimit = IMPORT_CHUNK;
      const total = itemsToSort.length;
      const limit = Math.min(importRenderLimit, total);
      const visible = itemsToSort.slice(0, limit);
      const listHtml = visible.map((item, index) => {
        const store = getStoreByCode(item.storeCode);
        const status = !store ? 'NOT FOUND' : (store.active ? 'ACTIVE' : 'INACTIVE');
        const statusColor = !store ? '#e74c3c' : (store.active ? '#27ae60' : '#f39c12');
        return `
          <div class="queue-item">
            <div>
              <strong>${item.itemNumber}</strong> → ${item.storeCode}
              <div class="details">Qty: ${item.quantity} | <span style="color:${statusColor};">${status}</span> | Source: ${item.source}</div>
            </div>
            <button class="remove-btn" onclick="removeItem(${index})">×</button>
          </div>`;
      }).join('');
      const more = total - limit;
      const moreHtml = more > 0 ? `
        <div style="display:flex;justify-content:center;margin-top:8px;">
          <button class="big-button" onclick="loadMoreImport()">Show more (${more})</button>
        </div>` : '';
      const cont = $('importContainer');
      cont.innerHTML = listHtml + moreHtml;
      cont.classList.add('update-flash');
      setTimeout(()=>cont.classList.remove('update-flash'), 400);
      updateDistributeButtonState();
      if (typeof syncSidebarToQueue === 'function') syncSidebarToQueue();
    };

    const loadMoreImport = () => {
      importRenderLimit = Math.min(importRenderLimit + IMPORT_CHUNK, itemsToSort.length);
      updateImportDisplay();
    };

    const removeItem = index => {
      const cont = $('importContainer');
      const nodes = cont ? cont.querySelectorAll('.queue-item') : [];
      const node = nodes && nodes[index];
      const removed = itemsToSort[index];
      if (!removed) return;
      startUndo({type:'removeItem', payload:{item:{...removed}, index}});
      if (node) {
        node.classList.add('removing');
        setTimeout(() => { itemsToSort.splice(index,1); updateImportDisplay(); saveAppState(); }, 200);
      } else {
        itemsToSort.splice(index,1); updateImportDisplay(); saveAppState();
      }
    };
    const clearImport = () => { if(confirm('Clear all items?')){ const prev=[...itemsToSort]; startUndo({type:'clearImport', payload:{items:prev}}); itemsToSort=[]; updateImportDisplay(); saveAppState(); } };

    // -------- Combine duplicate items helper --------
    const shouldCombineDuplicates = () => !!($('combineToggle')?.checked || $('combineToggle2')?.checked);
    const combineAllDuplicates = () => {
      const map = new Map();
      const combined = [];
      itemsToSort.forEach(it => {
        const key = `${it.itemNumber}|${it.storeCode}`;
        if (!map.has(key)) { map.set(key, {...it}); combined.push(map.get(key)); }
        else { map.get(key).quantity += it.quantity; }
      });
      itemsToSort = combined;
      updateImportDisplay();
      saveAppState();
      showStatus('<strong>✅ Combined duplicate lines.</strong>', 'success');
    };

    // -------- Undo actions (Remove item / Clear import / Remove store) --------
    let pendingUndo = null;
    const showActionToast = (message, onUndo) => {
      const t = $('actionToast'); if (!t) return;
      t.innerHTML = `${message} <button id="undoBtn" class="copy-btn" style="margin-left:8px;">Undo</button>`;
      t.classList.add('show');
      const btn = $('undoBtn');
      const close = () => t.classList.remove('show');
      if (btn) btn.onclick = () => { try { onUndo && onUndo(); } finally { close(); pendingUndo=null; } };
      setTimeout(close, 5000);
    };
    const startUndo = (action) => {
      pendingUndo = action;
      if (action.type === 'removeItem') {
        showActionToast('Item removed.', () => {
          const {item, index} = action.payload; itemsToSort.splice(Math.min(index, itemsToSort.length), 0, item); updateImportDisplay(); saveAppState();
        });
      } else if (action.type === 'clearImport') {
        showActionToast('Cleared import.', () => { itemsToSort = action.payload.items; updateImportDisplay(); saveAppState(); });
      } else if (action.type === 'removeStore') {
        showActionToast('Store removed.', () => { allStores.push(action.payload.store); rebuildStoreIndex(); updateStoreStatus(); saveUserPreferences(); });
      }
    };

    // Distribution and sorting
    const rankWeight = rank => RANK_WEIGHTS[String(rank).toUpperCase()] || 1;

    const getActiveTargetsInCurrentResults = () => {
      if (!lastResults?.sortedStores) return [];
      const resultCodes = new Set(lastResults.sortedStores.map(s => s.storeCode));
      return allStores
        .filter(s => s.active && resultCodes.has(s.code))
        .sort((a,b) => {
          const w = rankWeight(b.rank) - rankWeight(a.rank);
          return w !== 0 ? w : ((a._codeNum||999999) - (b._codeNum||999999));
        });
    };

    const hasProblemAssignments = () => {
      if (lastResults?.issues) return lastResults.issues.some(i => i.type === 'inactive' || i.type === 'not_found');
      return itemsToSort.some(it => {
        const s = getStoreByCode(it.storeCode);
        return !s || (s && !s.active);
      });
    };

    // Manual assignment helpers
    const getAllActiveStoresSorted = () => {
      return allStores
        .filter(s => s.active)
        .sort((a,b) => {
          const w = rankWeight(b.rank) - rankWeight(a.rank);
          const an = (a._codeNum || getCodeNumFromObj(a));
          const bn = (b._codeNum || getCodeNumFromObj(b));
          return w !== 0 ? w : (an - bn);
        });
    };
    const buildStoreOptionsHTML = (excludeCode = null) => {
      // Sort Assign-To dropdown by store code (ascending)
      const active = allStores
        .filter(s => s.active)
        .slice()
        .sort((a,b) => (a._codeNum ?? getCodeNumFromObj(a)) - (b._codeNum ?? getCodeNumFromObj(b)));
      if (!active.length) return '<option value="">No active stores</option>';
      const rows = ['<option value="">Select store…</option>'];
      active.forEach(s => { if (!excludeCode || s.code !== excludeCode) rows.push(`<option value="${s.code}">${s.code} - ${s.name} (${s.rank})</option>`); });
      return rows.join('');
    };

    const assignSelectedIssues = () => {
      const selects = document.querySelectorAll('.assign-select');
      let movedLines = 0, movedQty = 0;
      // Track deltas like auto-redistribute so UI highlights rows
      const pendingDeltas = {};
      selects.forEach(sel => {
        const target = sel.value;
        if (!target) return;
        const itemNumber = sel.getAttribute('data-item');
        const fromCode = sel.getAttribute('data-store');
        const qty = parseInt(sel.getAttribute('data-qty')) || 0;
        const targetStore = getStoreByCode(target);
        if (!targetStore || !targetStore.active) return;

        let idx = itemsToSort.findIndex(it => it.itemNumber === itemNumber && it.storeCode === fromCode && it.quantity === qty);
        if (idx === -1) idx = itemsToSort.findIndex(it => it.itemNumber === itemNumber && it.storeCode === fromCode);
        if (idx === -1) return;

        const src = itemsToSort[idx];
        itemsToSort.splice(idx, 1);

        const existingIdx = itemsToSort.findIndex(it => it.itemNumber === itemNumber && it.storeCode === target);
        if (existingIdx >= 0) {
          itemsToSort[existingIdx].quantity += qty;
          itemsToSort[existingIdx].source = 'Manual';
        } else {
          itemsToSort.push({ itemNumber, quantity: qty, storeCode: target, source: 'Manual' });
        }
        const key = `${itemNumber}|${target}`;
        pendingDeltas[key] = (pendingDeltas[key] || 0) + qty;
        movedLines += 1;
        movedQty += qty;
      });

      if (movedLines === 0) {
        showStatus('<strong>Info:</strong> No assignments selected. Choose a target store first.', 'info');
        return;
      }

      lastResults = null;
      if (movedLines > 0) {
        // Accumulate manual highlights; keep previous entries
        Object.keys(pendingDeltas).forEach(key => {
          const val = pendingDeltas[key] || 0;
          const entry = redistributionDeltas[key] || {auto:0, manual:0};
          // Backward-compat if numeric stored previously
          if (typeof entry === 'number') {
            redistributionDeltas[key] = {auto:entry, manual:val};
          } else {
            entry.manual = (entry.manual || 0) + val;
            redistributionDeltas[key] = entry;
          }
        });
      }
      updateImportDisplay();
      saveAppState();
      showStatus(`<strong>✅ Assigned:</strong> ${movedLines} line(s), ${movedQty} unit(s). Resorting...`, 'success');
      setTimeout(() => sortItems(), 50);
    };

    const distributeProblemItems = () => {
      const targets = getActiveTargetsInCurrentResults();
      if (targets.length === 0) {
        showStatus('<strong>ℹ️ No eligible target stores.</strong> Run "Sort by Store" first, and ensure at least one active store appears in results.', 'info');
        updateDistributeButtonState();
        return {moved:0, lines:0, targets:0};
      }

      // Preserve previous manual highlights; clear only auto deltas
      const prevD = redistributionDeltas || {};
      redistributionDeltas = {};
      Object.keys(prevD).forEach(k => {
        const v = prevD[k];
        const manual = typeof v === 'number' ? 0 : (v?.manual || 0);
        if (manual > 0) redistributionDeltas[k] = {auto:0, manual};
      });
      const redistributedItems = [];
      const problemAssignments = [];
      const keep = [];

      itemsToSort.forEach(it => {
        const s = getStoreByCode(it.storeCode);
        if (!s || !s.active) problemAssignments.push(it); else keep.push(it);
      });

      if (problemAssignments.length === 0) {
        showStatus('<strong>ℹ️ Nothing to distribute.</strong> No items are assigned to inactive or unknown stores.', 'info');
        updateDistributeButtonState();
        return {moved:0, lines:0, targets:targets.length};
      }

      const weights = targets.map(t => rankWeight(t.rank));
      const totalWeight = weights.reduce((a,b) => a+b, 0);
      let movedQty = 0;

      problemAssignments.forEach(src => {
        const qty = src.quantity;
        if (!Number.isFinite(qty) || qty <= 0) return;

        const shares = [];
        let allocated = 0;
        for (let i = 0; i < targets.length; i++) {
          const q = Math.floor(qty * (weights[i] / totalWeight));
          shares.push(q);
          allocated += q;
        }
        let remainder = qty - allocated, rIndex = 0;
        while (remainder-- > 0) shares[rIndex++ % shares.length]++;

        shares.forEach((q, i) => {
          if (q > 0) {
            const sc = targets[i].code;
            const key = `${src.itemNumber}|${sc}`;
            const entry = redistributionDeltas[key] || {auto:0, manual:0};
            if (typeof entry === 'number') {
              redistributionDeltas[key] = {auto: entry + q, manual: 0};
            } else {
              entry.auto = (entry.auto || 0) + q;
              redistributionDeltas[key] = entry;
            }
            redistributedItems.push({
              itemNumber: src.itemNumber,
              quantity: q,
              storeCode: sc,
              source: 'Redistributed'
            });
            movedQty += q;
          }
        });
      });

      itemsToSort = keep;
      
      redistributedItems.forEach(redItem => {
        const idx = itemsToSort.findIndex(it => 
          it.itemNumber === redItem.itemNumber && it.storeCode === redItem.storeCode
        );
        if (idx >= 0) {
          itemsToSort[idx].quantity += redItem.quantity;
          itemsToSort[idx].source = 'Redistributed';
        } else {
          itemsToSort.push(redItem);
        }
      });

      updateImportDisplay();
      lastResults = null;
      showStatus(`<strong>✅ Redistributed:</strong> ${problemAssignments.length} line(s), ${movedQty} unit(s) → ${targets.length} eligible store(s).`, 'success');
      updateDistributeButtonState();
      saveAppState();
      return {moved:movedQty, lines:problemAssignments.length, targets:targets.length};
    };

    const distributeAndResort = () => {
      distributeProblemItems();
      sortItems();
      $('fullResultsSection').scrollIntoView({behavior:'smooth'});
    };

    const sortItems = () => {
      if (itemsToSort.length === 0) { alert('Please import some items first'); return; }
      showStatus('<div style="color:var(--pink-1);">Processing…</div>', 'info');
      
      setTimeout(() => {
        const validItems = [];
        const issues = [];
        // Reset results virtualization for a fresh view
        resultsStoreRenderLimit = RESULTS_STORE_CHUNK;
        for (const k in expandedStoreItems) delete expandedStoreItems[k];
        
        itemsToSort.forEach(item => {
          const store = getStoreByCode(item.storeCode);
          if (!store) {
            issues.push({type:'not_found', itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, message:`Store ${item.storeCode} not found`});
          } else if (!store.active) {
            issues.push({type:'inactive', itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, storeName:store.name, message:`Store ${item.storeCode} - ${store.name} is inactive`});
          } else {
            validItems.push({itemNumber:item.itemNumber, quantity:item.quantity, storeCode:item.storeCode, storeName:store.name, rank:store.rank});
          }
        });

        const storeGroups = {};
        validItems.forEach(item => {
          const key = item.storeCode;
          if (!storeGroups[key]) {
            storeGroups[key] = {storeCode:key, storeName:item.storeName, rank:item.rank, items:[], totalQuantity:0};
          }
          storeGroups[key].items.push(item);
          storeGroups[key].totalQuantity += item.quantity;
        });

        const sortedStores = sortStoresNumerically(Object.values(storeGroups));
        displayResults({validItems, sortedStores, issues});
        lastResults = {validItems, sortedStores, issues};

        showStatus('<strong>✅ Complete.</strong> Results updated.', 'success');
        $('totalProcessed').textContent = validItems.length + issues.length;

        const section = $('fullResultsSection');
        section.classList.remove('hidden');
        updateDistributeButtonState();
        section.scrollIntoView({behavior:'smooth'});
        saveAppState();
      }, 80);
    };

    // Copy utilities
    const buildStoreClipboardText = (storeCode, asCSV) => {
      const store = lastResults?.sortedStores?.find(s => s.storeCode === storeCode);
      if (!store?.items?.length) return '';
      return store.items
        .slice()
        .sort((a,b) => a.itemNumber.localeCompare(b.itemNumber))
        .map(it => asCSV ? `${it.itemNumber},${it.quantity}` : `${it.itemNumber}\t${it.quantity}`)
        .join('\n');
    };

    const copyTextToClipboard = async text => {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        return true;
      } catch(e) { return false; }
    };

    const showToast = msg => {
      const t = $('copyToast');
      t.textContent = msg;
      t.classList.toggle('toast-light', !document.body.classList.contains('dark-mode'));
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    };

    const toggleStoreCollapse = storeCode => {
      collapsedStores[storeCode] = !collapsedStores[storeCode];
      if (lastResults) displayResults(lastResults);
      saveAppState();
    };

    const collapseAllStores = (collapse = true) => {
      if (!lastResults?.sortedStores) return;
      lastResults.sortedStores.forEach(s => { collapsedStores[s.storeCode] = collapse; });
      displayResults(lastResults);
      saveAppState();
    };

    const copyStoreItems = async (storeCode, evt) => {
      if (!lastResults) { showToast('Nothing to copy yet. Run "Sort by Store" first.'); return; }
      const asCSV = evt && evt.altKey;
      const text = buildStoreClipboardText(storeCode, asCSV);
      if (!text) { showToast('No lines for this store.'); return; }
      const ok = await copyTextToClipboard(text);
      if (ok) {
        showToast(asCSV ? 'Copied CSV: Item,Qty' : 'Copied: Item<TAB>Qty');
        copiedStores[storeCode] = true;
        collapsedStores[storeCode] = true;
        displayResults(lastResults);
        saveAppState();
      } else {
        showToast('Copy failed');
      }
    };

    // Results display
    const displayResults = ({validItems, sortedStores, issues}) => {
      const hasAnyDeltas = Object.keys(redistributionDeltas).length > 0;

      if (issues.length > 0) {
        $('issuesContainer').classList.remove('hidden');
        const totalIssueQty = issues.reduce((s,i) => s+i.quantity, 0);
        const hasProblems = issues.some(i => i.type === 'inactive' || i.type === 'not_found');

        const issuesEl = $('issuesContainer');
        issuesEl.innerHTML = `
          <div class="simple-alert alert-warning" style="margin-bottom:12px;">
            <strong>⚠️ ${issues.length} Items Need Attention</strong>
          </div>
          <div class="store-pane">
            <div class="store-pane-header">
              <div class="store-pane-title">Items Requiring Manual Handling</div>
              <div class="store-pane-stats">${totalIssueQty} units</div>
            </div>
            <div class="store-pane-body">
              <table class="store-pane-table sticky-head">
                <thead><tr><th>Item</th><th>Qty</th><th>Store Code</th><th>Issue</th><th>Assign To</th></tr></thead>
                <tbody>
                  ${issues.map(issue => `
                    <tr>
                      <td><strong>${issue.itemNumber}</strong></td>
                      <td>${issue.quantity}</td>
                      <td>${issue.storeCode}</td>
                      <td style="color:${issue.type === 'not_found' ? 'var(--danger)' : 'var(--warning)'};">${issue.message}</td>
                      <td>
                        <select class="assign-select" data-item="${issue.itemNumber}" data-store="${issue.storeCode}" data-qty="${issue.quantity}" style="min-width:220px;">
                          ${buildStoreOptionsHTML(issue.storeCode)}
                        </select>
                      </td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
            <div class="store-pane-actions">
              <button class="big-button success" onclick="assignSelectedIssues()" title="Move selected problem items to the chosen target stores and re-sort results">Manual Assign Selected → Re-Sort</button>
              <button id="distributeBtn" class="big-button" onclick="distributeAndResort()"
                      ${hasProblems ? '' : 'disabled'}
                      title="${hasProblems ? 'Automatically redistribute items from inactive or unknown stores to active stores based on rank priority, then re-sort results' : 'No problem items to distribute'}">
                Auto-Distribute Problems → Active (by Rank)
              </button>
            </div>
          </div>`;
        issuesEl.classList.add('update-flash');
        setTimeout(()=>issuesEl.classList.remove('update-flash'), 450);
      } else {
        $('issuesContainer').classList.add('hidden');
        $('issuesContainer').innerHTML = '';
      }

      const totalStores = sortedStores.length;
      const storeLimit = Math.min(resultsStoreRenderLimit, totalStores);
      const visibleStores = sortedStores.slice(0, storeLimit);

      const resultsEl = $('resultsContainer');
      resultsEl.innerHTML = `
        <div class="results-title">📦 Items Sorted by Store</div>
        <div class="simple-alert alert-info">
          <strong>📦 Items Sorted by Store</strong> - ${validItems.length} items sorted to ${sortedStores.length} active stores
          ${hasAnyDeltas ? `<div class=\"legend-note\">Green = auto, Yellow = manual additions.</div>` : ''}
        </div>
        <div class="store-panes">
          ${visibleStores.map(store => {
            const itemsSorted = store.items.slice().sort((a,b) => a.itemNumber.localeCompare(b.itemNumber));
            const expanded = !!expandedStoreItems[store.storeCode];
            const itemsLimited = expanded ? itemsSorted : itemsSorted.slice(0, RESULTS_ITEMS_CHUNK);
            const storeDeltaAuto = itemsSorted.reduce((sum,it) => {
              const d = redistributionDeltas[`${it.itemNumber}|${store.storeCode}`];
              return sum + (typeof d === 'number' ? d : (d?.auto || 0));
            }, 0);
            const storeDeltaManual = itemsSorted.reduce((sum,it) => {
              const d = redistributionDeltas[`${it.itemNumber}|${store.storeCode}`];
              return sum + (typeof d === 'number' ? 0 : (d?.manual || 0));
            }, 0);
            const isCollapsed = collapsedStores[store.storeCode];
            const isCopied = copiedStores[store.storeCode];

            return `
              <div class="store-pane ${isCollapsed ? 'collapsed' : ''}">
                <div class="store-pane-header">
                  <div class="store-pane-title">
                    <button class="collapse-toggle" onclick="toggleStoreCollapse('${store.storeCode}')" title="${isCollapsed ? 'Expand' : 'Collapse'}">
                      <span class="chev">▾</span> ${isCollapsed ? 'Expand' : 'Collapse'}
                    </button>
                    ${store.storeCode} - ${store.storeName}
                    <span class="rank-badge rank-${store.rank.toLowerCase()}" style="margin-left:4px;background:rgba(255,255,255,0.2);">${store.rank}</span>
                    ${isCopied ? '<span class="copied-badge" title="Copied to clipboard">Copied</span>' : ''}
                  </div>
                  <div class="store-pane-stats">
                    ${store.totalQuantity} units total
                    ${storeDeltaManual > 0 ? `<span class=\"delta-badge manual\">+${storeDeltaManual}</span>` : ''}
                    ${storeDeltaAuto > 0 ? `<span class=\"delta-badge auto\">+${storeDeltaAuto}</span>` : ''}
                    <button class="copy-btn" title="Copy Item & Qty (Tab). Hold Alt for CSV" onclick="copyStoreItems('${store.storeCode}', event)">📋 Copy</button>
                  </div>
                </div>
                <div class="store-pane-body">
                  <table class="store-pane-table sticky-head">
                    <thead><tr><th>Item</th><th>Qty</th><th>Code</th></tr></thead>
                    <tbody>
                      ${itemsLimited.map(it => {
                        const deltaRaw = redistributionDeltas[`${it.itemNumber}|${store.storeCode}`];
                        const dAuto = typeof deltaRaw === 'number' ? deltaRaw : (deltaRaw?.auto || 0);
                        const dManual = typeof deltaRaw === 'number' ? 0 : (deltaRaw?.manual || 0);
                        const rowClass = `${dAuto>0 ? 'redistributed-row' : ''} ${dManual>0 ? 'manual-row' : ''}`.trim();
                        return `
                        <tr class="${rowClass}">
                          <td><strong>${it.itemNumber}</strong></td>
                          <td>${it.quantity}
                            ${dManual>0 ? ` <span class=\"delta-badge manual\">+${dManual}</span>` : ''}
                            ${dAuto>0 ? ` <span class=\"delta-badge auto\">+${dAuto}</span>` : ''}
                          </td>
                          <td>${store.storeCode}</td>
                        </tr>`;
                      }).join('')}
                    </tbody>
                  </table>
                  ${!expanded && itemsSorted.length > itemsLimited.length ? `
                    <div style="display:flex;justify-content:center;margin-top:8px;">
                      <button class="big-button" onclick="expandStoreItems('${store.storeCode}')">Show ${itemsSorted.length - itemsLimited.length} more</button>
                    </div>` : ''}
                </div>
              </div>`;
          }).join('')}
        </div>
        ${totalStores > storeLimit ? `
          <div style="display:flex;justify-content:center;margin-top:8px;">
            <button class="big-button" onclick="loadMoreStores()">Show more stores (${totalStores - storeLimit})</button>
          </div>` : ''}
      `;
      resultsEl.classList.add('update-flash');
      setTimeout(()=>resultsEl.classList.remove('update-flash'), 450);
      updateDistributeButtonState();
      if (typeof syncSidebarToQueue === 'function') syncSidebarToQueue();
    };

    const loadMoreStores = () => {
      if (!lastResults?.sortedStores) return;
      resultsStoreRenderLimit = Math.min(resultsStoreRenderLimit + RESULTS_STORE_CHUNK, lastResults.sortedStores.length);
      displayResults(lastResults);
    };

    const expandStoreItems = (storeCode) => {
      expandedStoreItems[storeCode] = true;
      if (lastResults) displayResults(lastResults);
    };

    // Export functionality
    const exportResults = () => {
      if (!lastResults && itemsToSort.length === 0) {
        alert('No data to export. Please import and sort items first.');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;

      const dataSource = lastResults || generateQuickResults();
      const rows = [['Store Code','Store Name','Rank','Item','Qty']];
      
      if (dataSource.sortedStores?.length) {
        dataSource.sortedStores
          .slice()
          .sort((a,b) => (parseInt(a.storeCode)||999999) - (parseInt(b.storeCode)||999999))
          .forEach(store => {
            store.items
              .slice()
              .sort((a,b) => a.itemNumber.localeCompare(b.itemNumber))
              .forEach(it => rows.push([store.storeCode, store.storeName, store.rank, it.itemNumber, it.quantity]));
          });
      }

      const wsAll = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, wsAll, 'All Stores');

      if (dataSource.issues?.length) {
        const issuesRows = [['Item','Qty','Store Code','Issue']];
        dataSource.issues.forEach(i => issuesRows.push([i.itemNumber, i.quantity, i.storeCode, i.message]));
        const wsIssues = XLSX.utils.aoa_to_sheet(issuesRows);
        XLSX.utils.book_append_sheet(wb, wsIssues, 'Issues');
      }

      XLSX.writeFile(wb, `Inventory_Sorting_${stamp}.xlsx`);
    };

    const generateQuickResults = () => {
      const issues = [];
      const storeGroups = {};
      
      itemsToSort.forEach(item => {
        const store = getStoreByCode(item.storeCode);
        if (!store) {
          issues.push({type:'not_found', ...item, message:`Store ${item.storeCode} not found`});
          return;
        }
        if (!store.active) {
          issues.push({type:'inactive', ...item, storeName:store.name, message:`Store ${item.storeCode} - ${store.name} is inactive`});
          return;
        }
        
        const key = store.code;
        if (!storeGroups[key]) {
          storeGroups[key] = {storeCode: key, storeName: store.name, rank: store.rank, items: [], totalQuantity: 0};
        }
        storeGroups[key].items.push({itemNumber: item.itemNumber, quantity: item.quantity, storeCode: key, storeName: store.name, rank: store.rank});
        storeGroups[key].totalQuantity += item.quantity;
      });
      
      return {
        sortedStores: sortStoresNumerically(Object.values(storeGroups)),
        issues,
        validItems: Object.values(storeGroups).flatMap(s => s.items)
      };
    };

    const startOver = () => {
      if (confirm('Start over? This will clear everything.')) {
        try {
          itemsToSort.length = 0;
          lastResults = null;
          redistributionDeltas = {};
          currentWorkbook = null;
          for (let key in collapsedStores) delete collapsedStores[key];
          for (let key in copiedStores) delete copiedStores[key];
          for (let key in expandedStoreItems) delete expandedStoreItems[key];
          importRenderLimit = IMPORT_CHUNK;
          resultsStoreRenderLimit = RESULTS_STORE_CHUNK;
          const fileInput = $('fileInput');
          const pasteArea = $('pasteArea');
          const fileStatus = $('fileStatus');
          if (fileInput) { fileInput.value = ''; fileInput.files = null; }
          if (pasteArea) pasteArea.value = '';
          if (fileStatus) fileStatus.innerHTML = '';
          const sortingStatus = $('sortingStatus');
          const resultsStatus = $('resultsStatus');
          if (sortingStatus) sortingStatus.innerHTML = '';
          if (resultsStatus) resultsStatus.innerHTML = '';
          const fullResultsSection = $('fullResultsSection');
          const resultsContainer = $('resultsContainer');
          const issuesContainer = $('issuesContainer');
          if (fullResultsSection) fullResultsSection.classList.add('hidden');
          if (resultsContainer) resultsContainer.innerHTML = '';
          if (issuesContainer) { issuesContainer.innerHTML = ''; issuesContainer.classList.add('hidden'); }
          ['itemCount','storeDestinationCount','totalProcessed'].forEach(id => $(id).textContent = '0');
          updateImportDisplay();
          updateDistributeButtonState();
          updateStoreCounts();
          clearAppState();
          setTimeout(() => showStatus('<strong>✅ Reset complete.</strong> Ready for new data.', 'success'), 100);
        } catch (error) {
          alert(`Reset encountered an error: ${error.message}. Please refresh the page.`);
        }
      }
    };

    const toggleDarkMode = () => {
      const body = document.body;
      const toggleSwitch = $('toggleSwitch');
      const modeIcon = $('modeIcon');
      body.classList.toggle('dark-mode');
      toggleSwitch.classList.toggle('active');
      modeIcon.textContent = body.classList.contains('dark-mode') ? '🌙' : '☀️';
      saveUserPreferences();
    };

    const initializeDarkMode = () => {
      const preferences = getCookie(COOKIE_NAME);
      if (!preferences) {
        document.body.classList.add('dark-mode');
        $('toggleSwitch').classList.add('active');
        $('modeIcon').textContent = '🌙';
      }
    };

    const updateDistributeButtonState = () => {
      const btn = $('distributeBtn');
      if (!btn) return;
      const needed = hasProblemAssignments();
      const hasEligibleTargets = getActiveTargetsInCurrentResults().length > 0;
      btn.disabled = !(needed && hasEligibleTargets);
      btn.title = !needed ? 'No inactive or unknown-store items to distribute' : 
                  (!hasEligibleTargets ? 'No eligible target stores in current results' : 'Redistribute problem items to active stores (rank-weighted)');
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $('helpOverlay').style.display === 'flex') hideHelpOverlay();
    });

    document.addEventListener('DOMContentLoaded', () => {
      initializeDarkMode();
      loadAppState();
      loadUserPreferences();
      updateStoreStatus();
      updateImportDisplay();
      updateDistributeButtonState();
      // Back-to-top setup
      updateBackToTopVisibility();
      const btt = $('backToTopBtn');
      if (btt) btt.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
      // Align sidebar card bottom to item queue area
      setTimeout(syncSidebarToQueue, 0);
      // Drag & drop file import
      const ua = $('uploadArea');
      if (ua) {
        ua.addEventListener('dragover', e => { e.preventDefault(); ua.classList.add('dragover'); });
        ua.addEventListener('dragleave', () => ua.classList.remove('dragover'));
        ua.addEventListener('drop', e => {
          e.preventDefault(); ua.classList.remove('dragover');
          const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
          if (f) { $('fileStatus').innerHTML = '📊 Reading file...'; importFile(f); }
        });
      }
      // Keyboard shortcuts
      document.addEventListener('keydown', (ev) => {
        const tag = (ev.target && ev.target.tagName || '').toLowerCase();
        const typing = tag === 'input' || tag === 'textarea' || ev.target.isContentEditable;
        if (typing) return;
        if (ev.key === '?') { showHelpOverlay(); ev.preventDefault(); }
        if (ev.key === 's' || ev.key === 'S') { sortItems(); ev.preventDefault(); }
        if (ev.key === 'e' || ev.key === 'E') { exportResults(); ev.preventDefault(); }
        if (ev.key === 'd' || ev.key === 'D') { const b=$('distributeBtn'); if (b && !b.disabled) { distributeAndResort(); } ev.preventDefault(); }
        if (ev.key === 'm' || ev.key === 'M') { if (typeof assignSelectedIssues === 'function') assignSelectedIssues(); ev.preventDefault(); }
        if (ev.key === 'a') { toggleAllStores(true); ev.preventDefault(); }
        if (ev.key === 'A') { toggleAllStores(false); ev.preventDefault(); }
        if (ev.key === 'f' || ev.key === 'F') { const si=$('storeSearchInput'); if (si){ si.focus(); ev.preventDefault(); } }
      });
    });

    const updateBackToTopVisibility = () => {
      const y = window.scrollY || document.documentElement.scrollTop || 0;
      const btt = $('backToTopBtn');
      if (!btt) return;
      if (y > 250) btt.classList.add('show'); else btt.classList.remove('show');
    };
    window.addEventListener('scroll', updateBackToTopVisibility, {passive:true});

    window.addEventListener('beforeunload', saveAppState);

    // Sidebar height alignment to the two-col (Import Queue + Actions) area
    let _resizeAlignTimer = null;
    const syncSidebarToQueue = () => {
      try {
        if (window.matchMedia('(max-width: 1100px)').matches) {
          const lc = document.querySelector('.sidebar .card');
          if (lc) lc.style.height = '';
          return;
        }
        const leftCard = document.querySelector('.sidebar .card');
        const twoCol = document.querySelector('.two-col');
        if (!leftCard || !twoCol) return;
        const leftTop = leftCard.getBoundingClientRect().top;
        const bottom = twoCol.getBoundingClientRect().bottom;
        const h = Math.max(200, Math.round(bottom - leftTop));
        leftCard.style.height = h + 'px';
      } catch (e) {}
    };
    window.addEventListener('resize', () => {
      clearTimeout(_resizeAlignTimer);
      _resizeAlignTimer = setTimeout(syncSidebarToQueue, 60);
    });

    // Scroll hint fades for scrollable store lists
    function initScrollHints(ctx){
      try {
        const root = ctx || document;
        const panes = root.querySelectorAll('.store-pane-body');
        panes.forEach(p => {
          // Ensure a hint element exists
          let hint = p.querySelector('.scroll-hint');
          if (!hint) {
            hint = document.createElement('div');
            hint.className = 'scroll-hint';
            hint.setAttribute('aria-hidden','true');
            hint.textContent = 'Scroll for more ▼';
            p.appendChild(hint);
          }
          // Ensure fade elements exist (top and bottom)
          if (!p.querySelector('.fade-top')){
            const ft = document.createElement('div');
            ft.className = 'fade-top';
            p.insertBefore(ft, p.firstChild);
          }
          if (!p.querySelector('.fade-bottom')){
            const fb = document.createElement('div');
            fb.className = 'fade-bottom';
            p.appendChild(fb);
          }
          const update = () => {
            const has = (p.scrollHeight - p.clientHeight) > 2;
            if (has) p.classList.add('scrollable'); else p.classList.remove('scrollable');
            const atTop = p.scrollTop <= 0;
            const atBottom = (p.scrollTop + p.clientHeight) >= (p.scrollHeight - 1);
            p.classList.toggle('at-top', atTop);
            p.classList.toggle('at-bottom', atBottom);
            // Toggle hint visibility: show when scrollable and not at bottom
            if (has && !atBottom) hint.classList.add('show'); else hint.classList.remove('show');
          };
          update();
          p.addEventListener('scroll', update, {passive:true});
          window.addEventListener('resize', update);
        });
      } catch {}
    }

    // Make the entire visual Help area clickable and keyboard-activatable
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const helpWrap = document.querySelector('.help-button');
        if (helpWrap) {
          helpWrap.addEventListener('click', () => { if (typeof showHelpOverlay === 'function') showHelpOverlay(); });
          helpWrap.setAttribute('role','button');
          helpWrap.setAttribute('tabindex','0');
          helpWrap.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); if (typeof showHelpOverlay === 'function') showHelpOverlay(); }
          });
        }
      } catch {}
    });

    // Ensure Manual Assign and Auto-Distribute buttons match highlight colors
    (function(){
      function styleActionButtons(ctx){
        try {
          const root = ctx || document;
          const manualBtn = Array.from(root.querySelectorAll('button.big-button[onclick^="assignSelectedIssues"]'))[0];
          if (manualBtn) {
            manualBtn.id = 'manualAssignBtn';
            manualBtn.classList.remove('success');
            if (!manualBtn.classList.contains('warning')) manualBtn.classList.add('warning');
          }
          const distributeBtn = document.getElementById('distributeBtn');
          if (distributeBtn) {
            if (!distributeBtn.classList.contains('success')) distributeBtn.classList.add('success');
          }
        } catch(e) { /* no-op */ }
      }
      document.addEventListener('DOMContentLoaded', () => {
        styleActionButtons();
        const issues = document.getElementById('issuesContainer');
        if (issues && 'MutationObserver' in window) {
          const mo = new MutationObserver(() => styleActionButtons(issues));
          mo.observe(issues, { childList: true, subtree: true });
        }
        // Initialize scroll hints on load and when results change
        initScrollHints();
        const results = document.getElementById('resultsContainer');
        if (results && 'MutationObserver' in window){
          const mo2 = new MutationObserver(() => initScrollHints(results));
          mo2.observe(results, { childList:true, subtree:true });
        }
      });
    })();
  </script>
</body>
</html>
